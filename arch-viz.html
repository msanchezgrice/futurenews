<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Futurenews — Architecture Visualization</title>
<style>
  :root {
    --bg: #0d1117;
    --card: #161b22;
    --card-hover: #1c2333;
    --border: #30363d;
    --fg: #c9d1d9;
    --fg-muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --cyan: #39d353;
    --pink: #f778ba;
    --yellow: #e3b341;
    --mono: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
    --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--fg); font-family: var(--sans); line-height: 1.6; }

  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,17,23,0.92); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
  }
  nav a {
    color: var(--fg-muted); text-decoration: none;
    font-size: 13px; font-family: var(--mono);
    padding: 4px 12px; border-radius: 6px;
    border: 1px solid transparent; transition: all .15s;
  }
  nav a:hover, nav a.active { color: var(--accent); border-color: var(--accent); background: rgba(88,166,255,0.08); }
  nav .title { font-weight: 700; font-size: 15px; color: var(--fg); margin-right: 16px; letter-spacing: .02em; }

  .section { max-width: 1200px; margin: 0 auto; padding: 48px 24px 24px; }
  .section h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
  .section h2 .num { font-family: var(--mono); font-size: 14px; color: var(--accent); opacity: .7; }
  .section .subtitle { color: var(--fg-muted); font-size: 14px; margin-bottom: 24px; }
  .section h3 { margin-top: 28px; font-size: 15px; color: var(--fg-muted); margin-bottom: 12px; }

  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
  .card {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 20px; transition: border-color .15s, background .15s;
  }
  .card:hover { border-color: var(--accent); background: var(--card-hover); }
  .card h3 { font-size: 15px; font-weight: 600; margin: 0 0 8px; display: flex; align-items: center; gap: 8px; color: var(--fg); }
  .card p, .card ul { font-size: 13px; color: var(--fg-muted); }
  .card ul { padding-left: 18px; }
  .card li { margin: 3px 0; }
  .card code { font-family: var(--mono); font-size: 12px; background: rgba(88,166,255,0.08); color: var(--accent); padding: 1px 6px; border-radius: 4px; }

  .badge { display: inline-block; font-family: var(--mono); font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .badge-green { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge-orange { background: rgba(210,153,34,0.15); color: var(--orange); }
  .badge-purple { background: rgba(188,140,255,0.15); color: var(--purple); }
  .badge-red { background: rgba(248,81,73,0.15); color: var(--red); }
  .badge-cyan { background: rgba(57,211,83,0.12); color: var(--cyan); }
  .badge-blue { background: rgba(88,166,255,0.12); color: var(--accent); }
  .badge-pink { background: rgba(247,120,186,0.12); color: var(--pink); }
  .badge-yellow { background: rgba(227,179,65,0.12); color: var(--yellow); }

  .flow { display: flex; align-items: stretch; gap: 0; overflow-x: auto; padding: 16px 0; }
  .flow-step {
    flex: 0 0 auto; min-width: 155px; max-width: 190px;
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 14px; text-align: center;
  }
  .flow-step .step-num { font-family: var(--mono); font-size: 11px; color: var(--accent); opacity: .6; margin-bottom: 4px; }
  .flow-step h4 { font-size: 14px; margin-bottom: 6px; }
  .flow-step p { font-size: 11px; color: var(--fg-muted); }
  .flow-arrow { flex: 0 0 36px; display: flex; align-items: center; justify-content: center; color: var(--fg-muted); font-size: 18px; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 16px 0; }
  th, td { text-align: left; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  th { font-family: var(--mono); font-size: 11px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: .04em; background: rgba(22,27,34,0.7); position: sticky; top: 48px; }
  td code { font-family: var(--mono); font-size: 12px; color: var(--accent); }
  tr:hover td { background: rgba(88,166,255,0.03); }

  .schema-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
  .schema-table { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .schema-table .table-name { font-family: var(--mono); font-size: 13px; font-weight: 700; padding: 10px 14px; background: rgba(88,166,255,0.06); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .schema-table .cols { padding: 8px 14px; font-size: 12px; font-family: var(--mono); color: var(--fg-muted); }
  .schema-table .cols .pk { color: var(--orange); }
  .schema-table .cols .fk { color: var(--purple); }
  .schema-table .cols div { padding: 2px 0; }

  .cost-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
  .cost-label { flex: 0 0 220px; font-size: 13px; font-family: var(--mono); color: var(--fg-muted); text-align: right; }
  .cost-bar-bg { flex: 1; height: 24px; background: var(--card); border-radius: 4px; overflow: hidden; border: 1px solid var(--border); }
  .cost-bar { height: 100%; border-radius: 3px; transition: width .6s ease; display: flex; align-items: center; padding-left: 8px; font-size: 11px; font-family: var(--mono); color: #fff; font-weight: 600; }
  .cost-val { flex: 0 0 100px; font-size: 13px; font-family: var(--mono); color: var(--fg); }

  .state-machine { display: flex; flex-wrap: wrap; gap: 24px; padding: 16px 0; }
  .sm-group { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; flex: 1; min-width: 300px; }
  .sm-group h4 { font-size: 14px; margin-bottom: 12px; color: var(--accent); }
  .sm-states { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
  .sm-state { font-family: var(--mono); font-size: 12px; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: rgba(22,27,34,0.8); }
  .sm-arrow { color: var(--fg-muted); font-size: 16px; }

  .file-tree {
    font-family: var(--mono); font-size: 13px;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 8px; padding: 20px; line-height: 1.8; overflow-x: auto;
  }
  .file-tree .dir { color: var(--accent); font-weight: 600; }
  .file-tree .file { color: var(--fg-muted); }
  .file-tree .comment { color: var(--fg-muted); opacity: .5; font-style: italic; }
  .file-tree .lines { color: var(--orange); font-size: 11px; }

  .env-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 12px; }
  .env-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .env-card h4 { font-size: 13px; font-family: var(--mono); color: var(--accent); margin-bottom: 10px; }
  .env-card .env-row { display: flex; gap: 8px; font-size: 12px; font-family: var(--mono); line-height: 1.8; }
  .env-card .env-key { color: var(--green); min-width: 220px; }
  .env-card .env-val { color: var(--fg-muted); }

  .divider { height: 1px; background: var(--border); margin: 40px 0; }
  .stat-row { display: flex; gap: 24px; flex-wrap: wrap; margin: 16px 0; }
  .stat { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px 20px; min-width: 140px; }
  .stat .val { font-size: 28px; font-weight: 700; font-family: var(--mono); color: var(--accent); }
  .stat .label { font-size: 12px; color: var(--fg-muted); margin-top: 4px; }

  @media (max-width: 768px) {
    .flow { flex-direction: column; align-items: center; }
    .flow-arrow { transform: rotate(90deg); flex: 0 0 30px; }
    .cards { grid-template-columns: 1fr; }
    .schema-grid { grid-template-columns: 1fr; }
    .env-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<nav>
  <span class="title">Futurenews Architecture</span>
  <a href="#overview">Overview</a>
  <a href="#files">Files</a>
  <a href="#pipeline">Pipeline</a>
  <a href="#states">States</a>
  <a href="#schema">Database</a>
  <a href="#api">API</a>
  <a href="#env">Env Vars</a>
  <a href="#llm">LLM Usage</a>
  <a href="#costs">Cost Estimate</a>
</nav>

<!-- ═══════════════════════════════════════════ -->
<div class="section" id="overview">
  <h2><span class="num">01</span> System Overview</h2>
  <p class="subtitle">A "future newspaper" — fetches real-world signals, clusters into topics, generates a +5-year edition, curates with Sonnet (extended thinking), and renders articles on-click via Anthropic Sonnet API. 9,402 lines of JS. Single dependency: <code>ws</code>.</p>

  <div class="stat-row">
    <div class="stat"><div class="val">9,402</div><div class="label">Lines of JS</div></div>
    <div class="stat"><div class="val">22</div><div class="label">Data Sources</div></div>
    <div class="stat"><div class="val">14</div><div class="label">DB Tables</div></div>
    <div class="stat"><div class="val">24+</div><div class="label">API Routes</div></div>
    <div class="stat"><div class="val">3</div><div class="label">LLM Touchpoints</div></div>
    <div class="stat"><div class="val">8</div><div class="label">News Sections</div></div>
    <div class="stat"><div class="val">+5y</div><div class="label">Single Edition</div></div>
  </div>

  <div class="cards" style="margin-top:24px;">
    <div class="card">
      <h3><span class="badge badge-blue">INGEST</span> 22 Sources</h3>
      <ul>
        <li><strong>15 RSS feeds</strong> — NPR, BBC, Guardian (×5), PBS, Ars Technica (×2), HN, TechCrunch AI, Verge AI, MIT Tech Review</li>
        <li><strong>4 arXiv RSS</strong> — cs.AI, cs.LG, cs.CL, cs.RO (240min interval)</li>
        <li><strong>1 Polymarket API</strong> — prediction market questions/probabilities</li>
        <li><strong>5 FRED CSV series</strong> — UNRATE, CPIAUCSL, FEDFUNDS, DGS10, DGS2 (as 1 source entry)</li>
      </ul>
      <p style="margin-top:8px">Refresh: <code>60-240 min</code> per source</p>
    </div>
    <div class="card">
      <h3><span class="badge badge-green">PIPELINE</span> Signal → Edition</h3>
      <ul>
        <li>Fetch → <code>raw_items</code> (dedup by URL fingerprint)</li>
        <li>Classify → <code>signals</code> (section, horizon, score, entities)</li>
        <li>Cluster → <code>topics</code> (Jaccard similarity >0.3)</li>
        <li>Match → <code>topic_evidence</code> (standing topics enrichment)</li>
        <li>Generate → <code>editions</code> (single +5y edition)</li>
        <li>Curate → <code>story_curations</code> (all stories get full draftArticle + confidence)</li>
      </ul>
    </div>
    <div class="card">
      <h3><span class="badge badge-purple">LLM</span> Three Touchpoints</h3>
      <ul>
        <li><strong>Curation</strong> — Sonnet with extended thinking (10K budget). Writes all stories: headlines, deks, draftArticle, confidence scores</li>
        <li><strong>Rendering</strong> — Sonnet 4.6 generates article body on-click via HTTP API (no WebSocket)</li>
        <li><strong>Images</strong> — DALL-E 3 generates hero images per story (1792×1024)</li>
      </ul>
      <p style="margin-top:8px">No mock fallback — curation requires <code>anthropic</code> or <code>openai</code> mode</p>
    </div>
    <div class="card">
      <h3><span class="badge badge-orange">SERVE</span> Node.js HTTP</h3>
      <ul>
        <li>Pure Node.js <code>http</code> module (no Express)</li>
        <li>Article rendering via Anthropic HTTP API + client-side polling</li>
        <li>Port: <code>57965</code> (tries +53 up to 48 times on conflict)</li>
        <li>Admin auth: cookie-based with <code>ADMIN_SECRET</code></li>
        <li>Vercel Edge API wrappers in <code>api/</code></li>
      </ul>
    </div>
    <div class="card">
      <h3><span class="badge badge-cyan">FRONTEND</span> Vanilla JS SPA</h3>
      <ul>
        <li>1,330 lines — two pages: index (edition grid) + article (rendered body)</li>
        <li>8 sections: U.S., World, Business, Technology, AI, Arts, Lifestyle, Opinion</li>
        <li>LocalStorage cache v16: articles 20min TTL, editions 60min TTL</li>
        <li>HTTP polling for article rendering (no WebSocket)</li>
        <li>Confidence badges on article cards (color-coded 0-100)</li>
      </ul>
    </div>
    <div class="card">
      <h3><span class="badge badge-pink">DATA</span> SQLite</h3>
      <ul>
        <li>WAL mode + NORMAL sync + foreign keys ON</li>
        <li>14 tables, schema version 2, 12 indices</li>
        <li>6 standing topics with extrapolation axes &amp; milestones</li>
        <li>Render cache key: <code>render-{storyId}-v19-c{hash}</code></li>
        <li>Runtime config: <code>~/.futurenews/runtime.json</code> (0600 perms)</li>
        <li>Force rebuild clears: render_cache, story_curations, day_curations</li>
      </ul>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="files">
  <h2><span class="num">02</span> File Structure</h2>
  <p class="subtitle">Node.js 22+ ES modules, single dependency (ws), 9,402 lines across JS/HTML/CSS files.</p>

  <div class="file-tree">
<span class="dir">server/</span>
  <span class="file">server.js</span>        <span class="lines">2,745 lines</span> <span class="comment">— HTTP server, Sonnet article renderer, admin dashboard, article prompt builder</span>
  <span class="file">worker.js</span>        <span class="comment">— Scheduled daily pipeline runner (cron-style PIPELINE_DAILY_HHMM)</span>
  <span class="file">refresh.js</span>       <span class="comment">— One-shot pipeline refresh CLI</span>
  <span class="dir">pipeline/</span>
    <span class="file">pipeline.js</span>      <span class="lines">2,481 lines</span> <span class="comment">— FutureTimesPipeline class: fetch/classify/cluster/enrich/generate/curate/image-gen</span>
    <span class="file">curation.js</span>      <span class="lines">537 lines</span>  <span class="comment">— Curation: prompt builder, Anthropic API w/ extended thinking, JSON parsing</span>
    <span class="file">sonnet-curator.js</span>  <span class="lines">584 lines</span>  <span class="comment">— Mock curator: deterministic curation templates, outline generation</span>
    <span class="file">db.js</span>            <span class="lines">247 lines</span>  <span class="comment">— SQLite schema, migrations, 14 tables + 12 indices</span>
    <span class="file">rss.js</span>           <span class="comment">— RSS/Atom feed parser (regex-based, no XML lib)</span>
    <span class="file">polymarket.js</span>    <span class="comment">— Polymarket Gamma API client</span>
    <span class="file">fred.js</span>          <span class="comment">— FRED economic data CSV parser</span>
    <span class="file">utils.js</span>         <span class="lines">121 lines</span>  <span class="comment">— sha256, slugify, tokenize, Jaccard, formatDay, stableHash</span>
    <span class="file">runtimeConfig.js</span> <span class="lines">116 lines</span>  <span class="comment">— ~/.futurenews/runtime.json read/write (0600 perms, atomic rename)</span>
<span class="dir">api/</span> <span class="comment">— Vercel Edge Function wrappers</span>
  <span class="file">edition.js</span>       <span class="lines">34 lines</span>
  <span class="file">day-signal.js</span>    <span class="lines">77 lines</span>
  <span class="file">article/[id].js</span>  <span class="lines">179 lines</span>
  <span class="dir">_lib/</span>
    <span class="file">pipeline.js</span>    <span class="lines">48 lines</span>   <span class="comment">— Singleton pipeline with /tmp DB fallback for Vercel</span>
    <span class="file">response.js</span>    <span class="lines">22 lines</span>   <span class="comment">— sendJson, sendHtml helpers</span>
<span class="dir">assets/</span>
  <span class="file">app.js</span>           <span class="lines">1,330 lines</span> <span class="comment">— Vanilla JS SPA (index + article, HTTP polling, confidence badges)</span>
  <span class="file">styles.css</span>       <span class="lines">721 lines</span>  <span class="comment">— Serif newspaper styling (NYT-inspired)</span>
<span class="dir">config/</span>
  <span class="file">sources.json</span>     <span class="lines">248 lines</span>  <span class="comment">— 22 data sources (15 RSS + 4 arXiv + 1 Polymarket + FRED)</span>
  <span class="file">standing-topics.json</span> <span class="lines">132 lines</span> <span class="comment">— 6 AI standing topics with axes &amp; milestones</span>
<span class="dir">data/</span>
  <span class="file">future-times.sqlite</span> <span class="comment">— Main database (~6.6 MB)</span>
<span class="file">index.html</span> <span class="lines">79 lines</span>
<span class="file">article.html</span> <span class="lines">61 lines</span> <span class="comment">— confidence badge, hidden edition selector (single +5y)</span>
<span class="file">package.json</span> <span class="comment">— deps: { ws: ^8.18.0 }</span>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="pipeline">
  <h2><span class="num">03</span> Pipeline Flow</h2>
  <p class="subtitle">7-stage data pipeline: fetch → classify → cluster → enrich → generate → curate → render. Single +5y edition. All stories get full draftArticle + confidence scores.</p>

  <div class="flow">
    <div class="flow-step">
      <div class="step-num">STAGE 1</div>
      <h4>Fetch</h4>
      <p>22 sources → <code>raw_items</code><br>Dedup by fingerprint<br>RSS + Polymarket + FRED</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step">
      <div class="step-num">STAGE 2</div>
      <h4>Classify</h4>
      <p>→ <code>signals</code><br>Section (keyword)<br>Horizon: near/mid/long<br>Entities + keywords<br>Score: type×recency×len</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step">
      <div class="step-num">STAGE 3</div>
      <h4>Cluster</h4>
      <p>→ <code>topics</code><br>Jaccard >0.3<br>Max 40/section/day<br>Top 12 keywords</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step" style="border-color:var(--cyan)">
      <div class="step-num" style="color:var(--cyan)">STAGE 4</div>
      <h4>Enrich</h4>
      <p>→ <code>topic_evidence</code><br>Match signals to<br>6 standing topics<br>AI sub-categorize</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step">
      <div class="step-num">STAGE 5</div>
      <h4>Generate</h4>
      <p>→ <code>editions</code><br>Single +5y edition<br>5 stories/section<br>Long-horizon mix</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step" style="border-color:var(--purple)">
      <div class="step-num" style="color:var(--purple)">STAGE 6 (LLM)</div>
      <h4>Curate</h4>
      <p>→ <code>story_curations</code><br>Extended thinking<br>ALL stories: draftArticle<br>Confidence scores 0-100</p>
    </div>
    <div class="flow-arrow">→</div>
    <div class="flow-step" style="border-color:var(--pink)">
      <div class="step-num" style="color:var(--pink)">STAGE 7 (click)</div>
      <h4>Render</h4>
      <p>→ <code>render_cache</code><br>Sonnet API on-click<br>HTTP polling (no WS)<br>+ DALL-E 3 images</p>
    </div>
  </div>

  <h3>Signal Scoring</h3>
  <div class="card" style="max-width:620px;">
    <p><code>score = typeBoost × recencyBoost × lengthBoost</code></p>
    <table style="margin:12px 0 0;">
      <tr><td><code>typeBoost</code></td><td>market=1.15, research=1.1, econ=0.95, news=1.0</td></tr>
      <tr><td><code>recencyBoost</code></td><td>max(0.2, 1.0 / (1.0 + ageHours / 18)) — half-life ~18h</td></tr>
      <tr><td><code>lengthBoost</code></td><td>0.6 + min(0.4, titleLength / 120)</td></tr>
    </table>
  </div>

  <h3>Section Classification</h3>
  <div class="card" style="max-width:620px;">
    <p>Keyword-match scoring across 8 sections. AI section has 6 sub-categories:</p>
    <div style="font-size:12px; font-family:var(--mono); color:var(--fg-muted); margin-top:8px; line-height:1.8;">
      <div><span style="color:var(--accent)">Foundation Models</span> — llm, gpt, claude, gemini, transformer, scaling...</div>
      <div><span style="color:var(--accent)">Robotics &amp; Embodied AI</span> — robot, humanoid, autonomous, self-driving...</div>
      <div><span style="color:var(--accent)">AI Agents</span> — agent, tool use, orchestration, multi-agent...</div>
      <div><span style="color:var(--accent)">AI Safety &amp; Governance</span> — alignment, regulation, bias, interpretability...</div>
      <div><span style="color:var(--accent)">Applied AI</span> — drug discovery, medical ai, text-to-image, weather...</div>
      <div><span style="color:var(--accent)">AI Industry</span> — nvidia, compute, data center, funding, valuation...</div>
    </div>
  </div>

  <h3>Confidence Scoring</h3>
  <div class="card" style="max-width:620px;">
    <p>Every story gets a <code>confidence</code> score (0-100) from the curator, rating prediction plausibility:</p>
    <table style="margin:12px 0 0;">
      <tr><td><span style="color:#2d7d46; font-weight:600">90-100</span></td><td>Near-certain extrapolation</td></tr>
      <tr><td><span style="color:#2d7d46; font-weight:600">70-89</span></td><td>Highly likely</td></tr>
      <tr><td><span style="color:#b8860b; font-weight:600">50-69</span></td><td>Plausible</td></tr>
      <tr><td><span style="color:#c0392b; font-weight:600">0-49</span></td><td>Speculative</td></tr>
    </table>
    <p style="margin-top:8px">Displayed as color-coded badges on article cards and article detail page.</p>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="states">
  <h2><span class="num">04</span> State Machines</h2>
  <p class="subtitle">Five lifecycle state machines plus frontend and scheduler state.</p>

  <div class="state-machine">
    <div class="sm-group">
      <h4>Raw Item → Signal → Topic Lifecycle</h4>
      <div class="sm-states">
        <div class="sm-state" style="border-color:var(--green)">fetched</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state">dedup (fingerprint)</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--accent)">raw_item</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--orange)">signal (scored)</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--purple)">topic (clustered)</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--cyan)">evidence (matched)</div>
      </div>
      <p style="margin-top:10px; font-size:12px; color:var(--fg-muted)">Dedup: sha256(canonical_url). Entity extraction: dict-based + proper-noun heuristic (max 10).</p>
    </div>

    <div class="sm-group">
      <h4>Edition Lifecycle</h4>
      <div class="sm-states">
        <div class="sm-state" style="border-color:var(--green)">topics ready</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--accent)">snapshot built</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--accent)">edition generated</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--purple)">curated (all stories)</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--orange)">served</div>
      </div>
      <p style="margin-top:10px; font-size:12px; color:var(--fg-muted)">UNIQUE(day, years_forward). Single +5y edition per day. Force rebuild clears render_cache + story_curations + day_curations.</p>
    </div>

    <div class="sm-group">
      <h4>Article Render Lifecycle</h4>
      <div class="sm-states">
        <div class="sm-state" style="border-color:var(--fg-muted)">idle</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--accent)">POST /api/article/:id</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--orange)">Sonnet generating</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--green)">complete</div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <div class="sm-state" style="border-color:var(--cyan)">cached (3-layer hit)</div>
        <span class="sm-arrow" style="font-size:12px">skip to complete</span>
        <div class="sm-state" style="border-color:var(--purple)">draftArticle exists</div>
        <span class="sm-arrow" style="font-size:12px">skip render</span>
        <div class="sm-state" style="border-color:var(--red)">error (no fallback)</div>
      </div>
      <p style="margin-top:10px; font-size:12px; color:var(--fg-muted)">
        If draftArticle body >200 chars → skip Sonnet, use curator's draft directly.<br>
        Client polls via HTTP (no WebSocket streaming).<br>
        Cache layers: Memory Map → SQLite render_cache → localStorage (20min TTL)
      </p>
    </div>

    <div class="sm-group">
      <h4>Curation Mode</h4>
      <div style="font-family:var(--mono); font-size:12px; line-height:2;">
        <div><span class="badge badge-purple">anthropic</span> Extended thinking (Sonnet) or temp 0.4 (Haiku). Fallback: Sonnet → Haiku on 404</div>
        <div><span class="badge badge-blue">openai</span> OpenAI Responses API (/v1/responses)</div>
        <div><span class="badge badge-red">error</span> Unknown mode throws — no mock fallback</div>
      </div>
      <p style="margin-top:8px; font-size:12px; color:var(--fg-muted)">Extended thinking: budget 10K tokens for Sonnet models. Thinking traces logged but not stored.</p>
    </div>

    <div class="sm-group">
      <h4>Server Scheduler</h4>
      <div class="sm-states">
        <div class="sm-state" style="border-color:var(--green)">boot</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--accent)">tick: refresh()</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--purple)">curateDay()</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--fg-muted)">sleep</div>
        <span class="sm-arrow">↻</span>
      </div>
      <p style="margin-top:10px; font-size:12px; color:var(--fg-muted)">
        Server: <code>PIPELINE_REFRESH_MS</code> = 3,600,000ms (1h interval)<br>
        Worker: <code>PIPELINE_DAILY_HHMM</code> = "05:30" (cron-style scheduled)<br>
        Auto-curate: <code>SONNET_AUTO_CURATE</code> ≠ false → curate after each refresh
      </p>
    </div>

    <div class="sm-group">
      <h4>Frontend State</h4>
      <div style="font-family:var(--mono); font-size:12px; line-height:1.9; color:var(--fg-muted);">
        <div><span style="color:var(--accent)">state.section</span> = "All" | "U.S." | "World" | ... (8 sections)</div>
        <div><span style="color:var(--accent)">state.day</span> = "YYYY-MM-DD"</div>
        <div><span style="color:var(--accent)">state.editions</span> = { key → cached edition } (localStorage, 60min TTL)</div>
        <div><span style="color:var(--accent)">state.articles</span> = { key → rendered article } (localStorage, 20min TTL)</div>
        <div style="margin-top:6px"><span style="color:var(--orange)">yearsForward</span> = 5 (fixed, single edition)</div>
        <div><span style="color:var(--orange)">inflightArticles</span> = Map&lt;requestId, callback&gt;</div>
        <div><span style="color:var(--orange)">prefetchedArticles</span> = Set&lt;storyId&gt;</div>
        <div><span style="color:var(--green)">confidence</span> = 0-100 per article (color-coded badge)</div>
      </div>
    </div>

    <div class="sm-group">
      <h4>Admin Auth Flow</h4>
      <div class="sm-states">
        <div class="sm-state" style="border-color:var(--fg-muted)">no secret set</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--green)">open access (dev)</div>
      </div>
      <div class="sm-states" style="margin-top:8px">
        <div class="sm-state" style="border-color:var(--orange)">ADMIN_SECRET set</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state">check ?secret= or cookie</div>
        <span class="sm-arrow">→</span>
        <div class="sm-state" style="border-color:var(--green)">Set-Cookie: ft_admin (30d)</div>
      </div>
      <p style="margin-top:10px; font-size:12px; color:var(--fg-muted)">HttpOnly, SameSite=Lax. Protected: /api/admin/*, /api/day-signal.</p>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="schema">
  <h2><span class="num">05</span> Database Schema</h2>
  <p class="subtitle">SQLite, WAL mode, schema version 2. 14 tables, 12 indices.</p>

  <div class="schema-grid">
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-blue">KV</span> meta</div>
      <div class="cols"><div><span class="pk">key TEXT PK</span></div><div>value TEXT</div></div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-green">SRC</span> sources</div>
      <div class="cols">
        <div><span class="pk">source_id TEXT PK</span></div>
        <div>name, type, section, url, enabled</div>
        <div>fetch_interval_minutes</div>
        <div>last_fetched_at, last_error, last_status</div>
        <div>last_item_count, meta_json</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-green">INGEST</span> raw_items</div>
      <div class="cols">
        <div><span class="pk">raw_id INTEGER PK AUTO</span></div>
        <div><span class="fk">source_id → sources</span></div>
        <div>day, fetched_at, published_at</div>
        <div>canonical_url, title, summary</div>
        <div>payload_json, section_hint</div>
        <div>fingerprint TEXT <span class="pk">UNIQUE</span></div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-orange">SIGNAL</span> signals</div>
      <div class="cols">
        <div><span class="pk">signal_id INTEGER PK AUTO</span></div>
        <div><span class="fk">raw_id → raw_items</span></div>
        <div>day, section, signal_type, horizon_bucket</div>
        <div>title, published_at, summary, canonical_url</div>
        <div>entities_json, keywords_json, citations_json</div>
        <div>score REAL</div>
        <div style="color:var(--accent)">IDX: (day, section)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-orange">CLUSTER</span> topics</div>
      <div class="cols">
        <div><span class="pk">topic_id INTEGER PK AUTO</span></div>
        <div>day, section, label, brief</div>
        <div>horizon_bucket, topic_slug</div>
        <div>evidence_signal_ids_json, evidence_links_json</div>
        <div>score REAL</div>
        <div style="color:var(--accent)">UQ: (day, topic_slug)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-purple">EDITION</span> editions</div>
      <div class="cols">
        <div><span class="pk">edition_id INTEGER PK AUTO</span></div>
        <div>day, years_forward, generated_at</div>
        <div>payload_json, version</div>
        <div style="color:var(--accent)">UQ: (day, years_forward)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-purple">STORIES</span> edition_stories</div>
      <div class="cols">
        <div><span class="pk">story_id TEXT PK</span></div>
        <div><span class="fk">edition_id → editions</span></div>
        <div>section, rank, topic_id, angle</div>
        <div>headline_seed, dek_seed, evidence_pack_json</div>
        <div style="color:var(--accent)">UQ: (edition_id, section, rank)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-pink">CACHE</span> render_cache</div>
      <div class="cols">
        <div><span class="pk">cache_key TEXT PK</span></div>
        <div>story_id, generated_at</div>
        <div>article_json (~5KB/article)</div>
        <div style="color:var(--accent)">IDX: (story_id)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-purple">CURATION</span> day_curations</div>
      <div class="cols">
        <div><span class="pk">day TEXT PK</span></div>
        <div>generated_at, provider, model</div>
        <div>prompt_json, payload_json, error</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-purple">CURATION</span> story_curations</div>
      <div class="cols">
        <div><span class="pk">story_id TEXT PK</span></div>
        <div>day, years_forward, section, rank</div>
        <div>generated_at, model, key_story INT</div>
        <div>plan_json, article_json</div>
        <div style="color:var(--accent)">IDX: (day), (day, years_forward)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-blue">SNAP</span> day_signal_snapshots</div>
      <div class="cols">
        <div><span class="pk">day TEXT PK</span></div>
        <div>generated_at, snapshot_json</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-blue">AUDIT</span> day_event_traces</div>
      <div class="cols">
        <div><span class="pk">event_id INTEGER PK AUTO</span></div>
        <div>day, ts, event_type, payload_json</div>
        <div style="color:var(--accent)">IDX: (day)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-cyan">AI</span> standing_topics</div>
      <div class="cols">
        <div><span class="pk">topic_key TEXT PK</span></div>
        <div>section, category, subcategory, label</div>
        <div>description, extrapolation_axes JSON</div>
        <div>keywords JSON, milestones JSON</div>
        <div>enabled INT, created_at, updated_at</div>
        <div style="color:var(--accent)">IDX: (section), (enabled)</div>
      </div>
    </div>
    <div class="schema-table">
      <div class="table-name"><span class="badge badge-cyan">AI</span> topic_evidence</div>
      <div class="cols">
        <div><span class="pk">id INTEGER PK AUTO</span></div>
        <div><span class="fk">standing_topic_key → standing_topics</span></div>
        <div><span class="fk">signal_id → signals</span></div>
        <div>day, relevance_score REAL</div>
        <div>matched_keywords JSON, ai_category</div>
        <div style="color:var(--accent)">UQ: (topic_key, signal_id)</div>
        <div style="color:var(--accent)">IDX: (topic_key), (day), (topic_key, day)</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="api">
  <h2><span class="num">06</span> API Routes</h2>
  <p class="subtitle">24+ HTTP routes from server.js. Admin routes protected by ADMIN_SECRET cookie auth. No WebSocket endpoints.</p>

  <table>
    <thead><tr><th>Method</th><th>Route</th><th>Purpose</th><th>Auth</th></tr></thead>
    <tbody>
      <tr><td>GET</td><td><code>/api/ping</code></td><td>Health check</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/config</code></td><td>Server config (sonnet mode, features)</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/edition?years=&day=</code></td><td>Edition payload (stories, sections, hero)</td><td>—</td></tr>
      <tr><td>GET/POST</td><td><code>/api/article/:id?years=&day=</code></td><td>GET: status/poll. POST: start Sonnet render job</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/pipeline/status</code></td><td>Pipeline health, counts, last refresh</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/pipeline/sources</code></td><td>All configured sources with status</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/pipeline/standing-topics</code></td><td>Standing topics registry (?section= filter)</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/pipeline/evidence-summary</code></td><td>Evidence summary for standing topics</td><td>—</td></tr>
      <tr><td>GET</td><td><code>/api/pipeline/topic-evidence</code></td><td>Signal-to-topic evidence mapping</td><td>—</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/day-signal?day=&format=</code></td><td>Signal pack (HTML/JSON/pretty)</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>POST</td><td><code>/api/admin/curate?force=</code></td><td>Trigger curation run</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET/POST</td><td><code>/api/admin/curator/runtime</code></td><td>Read/update Sonnet runtime config</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>POST</td><td><code>/api/admin/prerender</code></td><td>Pre-render articles for cache warming</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>POST</td><td><code>/api/admin/daily</code></td><td>Full pipeline refresh + curate (clears caches on force)</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/admin/trace?day=</code></td><td>Event trace audit log</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/admin/curation?years=</code></td><td>Curation details (HTML/JSON)</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/admin/curation/preview</code></td><td>Preview curation prompt before LLM call</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>POST</td><td><code>/api/admin/curation/apply</code></td><td>Apply curation from custom prompt</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>POST</td><td><code>/api/admin/curation/override</code></td><td>Manual per-story curation override</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/admin/dashboard</code></td><td>Full admin dashboard (HTML)</td><td>admin</td></tr>
      <tr style="background:rgba(188,140,255,0.04)"><td>GET</td><td><code>/api/admin/polymarket?years=</code></td><td>Polymarket implications explorer</td><td>admin</td></tr>
    </tbody>
  </table>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="env">
  <h2><span class="num">07</span> Environment Variables</h2>
  <p class="subtitle">All configuration via env vars, with runtime.json persistence for Sonnet settings.</p>

  <div class="env-grid">
    <div class="env-card">
      <h4>Server</h4>
      <div class="env-row"><span class="env-key">HOST</span><span class="env-val">127.0.0.1</span></div>
      <div class="env-row"><span class="env-key">PORT</span><span class="env-val">57965</span></div>
      <div class="env-row"><span class="env-key">PORT_FALLBACK_STEP</span><span class="env-val">53 (increment on conflict)</span></div>
      <div class="env-row"><span class="env-key">PORT_MAX_TRIES</span><span class="env-val">48</span></div>
      <div class="env-row"><span class="env-key">ADMIN_SECRET</span><span class="env-val">(optional, enables auth)</span></div>
      <div class="env-row"><span class="env-key">PIPELINE_DB_FILE</span><span class="env-val">data/future-times.sqlite</span></div>
      <div class="env-row"><span class="env-key">PIPELINE_SOURCES_FILE</span><span class="env-val">config/sources.json</span></div>
      <div class="env-row"><span class="env-key">PIPELINE_REFRESH_MS</span><span class="env-val">3600000 (1h)</span></div>
    </div>
    <div class="env-card">
      <h4>Sonnet Curation</h4>
      <div class="env-row"><span class="env-key">SONNET_MODE</span><span class="env-val">anthropic | openai (no mock fallback)</span></div>
      <div class="env-row"><span class="env-key">SONNET_MODEL</span><span class="env-val">claude-sonnet-4-6</span></div>
      <div class="env-row"><span class="env-key">SONNET_API_KEY</span><span class="env-val">(Anthropic/OpenAI key)</span></div>
      <div class="env-row"><span class="env-key">SONNET_API_URL</span><span class="env-val">(custom endpoint)</span></div>
      <div class="env-row"><span class="env-key">SONNET_SYSTEM_PROMPT</span><span class="env-val">(override system prompt)</span></div>
      <div class="env-row"><span class="env-key">SONNET_MAX_TOKENS</span><span class="env-val">32000 (4K-64K)</span></div>
      <div class="env-row"><span class="env-key">SONNET_TIMEOUT_MS</span><span class="env-val">900000 (15min)</span></div>
      <div class="env-row"><span class="env-key">SONNET_KEY_STORIES_PER_EDITION</span><span class="env-val">1 (0-7)</span></div>
      <div class="env-row"><span class="env-key">SONNET_AUTO_CURATE</span><span class="env-val">true (curate after refresh)</span></div>
    </div>
    <div class="env-card">
      <h4>Article Rendering</h4>
      <div class="env-row"><span class="env-key">ANTHROPIC_API_KEY</span><span class="env-val">(required for article rendering)</span></div>
      <div class="env-row"><span class="env-key">ARTICLE_MODEL</span><span class="env-val">claude-sonnet-4-6</span></div>
    </div>
    <div class="env-card">
      <h4>Image Generation + Worker</h4>
      <div class="env-row"><span class="env-key">OPENAI_API_KEY</span><span class="env-val">(DALL-E 3 image gen)</span></div>
      <div class="env-row"><span class="env-key">PIPELINE_DAILY_HHMM</span><span class="env-val">05:30 (worker schedule)</span></div>
      <div class="env-row"><span class="env-key">FUTURENEWS_RUNTIME_CONFIG_FILE</span><span class="env-val">~/.futurenews/runtime.json</span></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="llm">
  <h2><span class="num">08</span> LLM Usage Detail</h2>
  <p class="subtitle">Three LLM touchpoints: curation (batch, daily, extended thinking), rendering (Sonnet on-click), image generation (DALL-E 3 per-story).</p>

  <div class="cards" style="grid-template-columns: 1fr 1fr 1fr;">
    <div class="card" style="border-color:var(--purple)">
      <h3><span class="badge badge-purple">CURATION</span> Anthropic API</h3>
      <p style="margin-bottom:12px">1 batch call per edition. ALL ~20 stories curated with full draftArticle + confidence.</p>
      <table style="font-size:12px;">
        <tr><td>API</td><td><code>POST /v1/messages</code></td></tr>
        <tr><td>Model</td><td>claude-sonnet-4-6 (configurable)</td></tr>
        <tr><td>Thinking</td><td>Enabled, 10K budget (Sonnet)</td></tr>
        <tr><td>Temperature</td><td>N/A (thinking) or 0.4 (Haiku)</td></tr>
        <tr><td>Max tokens</td><td>32,000 (4K-64K)</td></tr>
        <tr><td>Timeout</td><td>900s (15min)</td></tr>
        <tr><td>Fallback</td><td>Sonnet → Haiku on 404</td></tr>
      </table>
      <div style="font-size:11px; margin-top:12px; color:var(--fg-muted);">
        <strong>Input (~3,200 tokens):</strong> editorial rules, prediction rules, AI extrapolation axes, all story candidates with citations<br>
        <strong>Thinking (~5,000 tokens):</strong> reasoning trace (logged, not stored)<br>
        <strong>Output (~10,000-16,000 tokens):</strong> curatedTitle, curatedDek, sparkDirections, futureEventSeed, confidence (0-100), draftArticle for EVERY story
      </div>
    </div>

    <div class="card" style="border-color:var(--pink)">
      <h3><span class="badge badge-pink">RENDERING</span> Anthropic Sonnet</h3>
      <p style="margin-bottom:12px">On-click via HTTP API. Skipped if draftArticle body already >200 chars.</p>
      <table style="font-size:12px;">
        <tr><td>API</td><td><code>POST /v1/messages</code> (streaming)</td></tr>
        <tr><td>Model</td><td>claude-sonnet-4-6 (<code>ARTICLE_MODEL</code>)</td></tr>
        <tr><td>Timeout</td><td>120s</td></tr>
        <tr><td>Auth</td><td><code>ANTHROPIC_API_KEY</code></td></tr>
        <tr><td>Fallback</td><td>None (errors propagated)</td></tr>
      </table>
      <div style="font-size:11px; margin-top:12px; color:var(--fg-muted);">
        <strong>Prompt:</strong> time anchor + rules + curator directions + headline/dek (~300 tokens)<br>
        <strong>Output:</strong> 4-8 paragraphs NYT-style prose, no Sources section, no markdown headers (~1,500 tokens)<br>
        <strong>Optimization:</strong> If curation produced a full draftArticle (>200 chars), rendering is skipped entirely
      </div>
    </div>

    <div class="card" style="border-color:var(--yellow)">
      <h3><span class="badge badge-yellow">IMAGES</span> DALL-E 3</h3>
      <p style="margin-bottom:12px">Hero image generation per story. Cached to filesystem.</p>
      <table style="font-size:12px;">
        <tr><td>API</td><td><code>POST /v1/images/generations</code></td></tr>
        <tr><td>Model</td><td>dall-e-3</td></tr>
        <tr><td>Size</td><td>1792 × 1024</td></tr>
        <tr><td>Quality</td><td>standard</td></tr>
        <tr><td>Timeout</td><td>60s gen + 30s download</td></tr>
        <tr><td>Cache</td><td>assets/img/generated/{storyId}.png</td></tr>
      </table>
      <div style="font-size:11px; margin-top:12px; color:var(--fg-muted);">
        Requires <code>OPENAI_API_KEY</code>. Generated once per storyId, never regenerated.
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════ -->
<div class="divider"></div>
<div class="section" id="costs">
  <h2><span class="num">09</span> LLM Cost Estimates</h2>
  <p class="subtitle">Sonnet 4.6: $15/M input, $75/M output. Haiku 4.5: $1/M, $5/M. DALL-E 3: $0.08/image. Extended thinking tokens charged at output rate.</p>

  <h3>Per Curation Call (Sonnet 4.6 with Extended Thinking)</h3>
  <table style="max-width:700px;">
    <thead><tr><th>Component</th><th>Tokens</th><th>Cost</th></tr></thead>
    <tbody>
      <tr><td>Input (prompt + candidates + axes)</td><td>~3,200</td><td>$0.048</td></tr>
      <tr><td>Thinking (reasoning trace)</td><td>~5,000</td><td>$0.375</td></tr>
      <tr><td>Output (20 stories × metadata + draftArticle)</td><td>~12,000</td><td>$0.900</td></tr>
      <tr style="font-weight:700"><td>Total per call</td><td>~20,200</td><td>~$1.32</td></tr>
    </tbody>
  </table>

  <h3>Per Render Call (Sonnet 4.6)</h3>
  <table style="max-width:700px;">
    <thead><tr><th>Component</th><th>Tokens</th><th>Cost</th></tr></thead>
    <tbody>
      <tr><td>Input (prompt + directions)</td><td>~300</td><td>$0.001</td></tr>
      <tr><td>Output (article body)</td><td>~1,500</td><td>$0.023</td></tr>
      <tr style="font-weight:700"><td>Total per render</td><td>~1,800</td><td>~$0.024</td></tr>
    </tbody>
  </table>
  <p style="font-size:12px; color:var(--fg-muted); margin-top:4px;">Skipped when draftArticle already has body >200 chars (most stories after curation).</p>

  <h3>Monthly Cost Scenarios</h3>

  <div class="cost-row">
    <div class="cost-label">Curation (Sonnet, 1/day)</div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:30%; background:var(--purple);">$39.60</div></div>
    <div class="cost-val">~$40/mo</div>
  </div>
  <div class="cost-row">
    <div class="cost-label">Curation (Sonnet, 1/day)</div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:7%; background:var(--accent);">$8</div></div>
    <div class="cost-val">~$8/mo</div>
  </div>
  <div class="cost-row">
    <div class="cost-label">Rendering (Sonnet, 20 clicks/day)</div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:12%; background:var(--pink);">$14.40</div></div>
    <div class="cost-val">~$14/mo</div>
  </div>
  <div class="cost-row">
    <div class="cost-label">DALL-E 3 (20 imgs/day)</div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:37%; background:var(--yellow);">$48</div></div>
    <div class="cost-val">~$48/mo</div>
  </div>
  <div class="cost-row">
    <div class="cost-label" style="color:var(--fg)"><strong>Full production (Sonnet)</strong></div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:80%; background:linear-gradient(90deg, var(--purple), var(--pink), var(--yellow));">$102</div></div>
    <div class="cost-val"><strong>~$102/mo</strong></div>
  </div>
  <div class="cost-row">
    <div class="cost-label" style="color:var(--fg)"><strong>Full production (Sonnet)</strong></div>
    <div class="cost-bar-bg"><div class="cost-bar" style="width:55%; background:linear-gradient(90deg, var(--accent), var(--pink), var(--yellow));">$70</div></div>
    <div class="cost-val"><strong>~$70/mo</strong></div>
  </div>

  <h3>Cost Optimization Design</h3>
  <div class="cards" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));">
    <div class="card"><h3 style="font-size:13px;">Single edition</h3><p>Only +5y instead of 11 variants (0-10). 1 curation call/day instead of 11.</p></div>
    <div class="card"><h3 style="font-size:13px;">All-story draftArticle</h3><p>Curation writes full body for every story. Most clicks skip Sonnet rendering entirely.</p></div>
    <div class="card"><h3 style="font-size:13px;">Batch curation</h3><p>~20 stories in 1 API call, not 20 separate calls.</p></div>
    <div class="card"><h3 style="font-size:13px;">Extended thinking</h3><p>10K budget for better predictions. Thinking traces logged but not persisted.</p></div>
    <div class="card"><h3 style="font-size:13px;">3-layer render cache</h3><p>Memory Map → SQLite → localStorage. Never re-render same article.</p></div>
    <div class="card"><h3 style="font-size:13px;">Model fallback chain</h3><p>Sonnet → Haiku on 404. Graceful degradation.</p></div>
    <div class="card"><h3 style="font-size:13px;">Image dedup</h3><p>DALL-E images cached per storyId, never regenerated.</p></div>
    <div class="card"><h3 style="font-size:13px;">Runtime config hot-swap</h3><p>Switch models/modes via admin API without restart.</p></div>
  </div>
</div>

<div style="height:80px;"></div>

<script>
  const sections = document.querySelectorAll('.section[id]');
  const navLinks = document.querySelectorAll('nav a');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        navLinks.forEach(a => a.classList.remove('active'));
        const active = document.querySelector(`nav a[href="#${entry.target.id}"]`);
        if (active) active.classList.add('active');
      }
    });
  }, { rootMargin: '-20% 0px -70% 0px' });
  sections.forEach(s => observer.observe(s));
</script>
</body>
</html>
